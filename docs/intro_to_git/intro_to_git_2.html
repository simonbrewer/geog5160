<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-01-01">

<title>GEOG 5160/6160: Introduction to git and GitHub: part 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head><body class="fullcontent">\usepackage{tabularx}






<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">GEOG 5160/6160: Introduction to git and GitHub: part 2</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p> </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>In this lab, we’ll work with branches in git and GitHub. Before introducing these, you’ll need to make sure you have a GitHub account setup and have created a repository called <code>myrepo</code>. We covered this in the first of these labs, but if you have not already set this up, the following section will explain how to do this. If you have, feel free to skip ahead to <code>Working with branches in git</code></p>
<section id="connect-to-github" class="level2">
<h2 class="anchored" data-anchor-id="connect-to-github">Connect to GitHub</h2>
<p>In this section, we will walk through the steps of connecting to GitHub for the first time, and both pulling from and pushing to GitHub from your computer. Before doing anything else, make a new folder on your computer where you can store the files for these labs. I’d suggest making this on your desktop and calling it <code>github</code>. Make a note of where this is, and then go to your terminal and change to this directory. Note that in a terminal:</p>
<ul>
<li><code>pwd</code> prints the current directory</li>
<li><code>cd</code> changes the directory
<ul>
<li><code>cd</code> will go to your home directory</li>
<li><code>cd ..</code> will go up one level</li>
<li><code>cd /path/to/my/files</code> will change to whatever path you have listed</li>
</ul></li>
<li><code>ls</code> will print a list of the files in the current directory</li>
</ul>
<p>Under Windows, you can change to a desktop folder by typing:</p>
<pre><code>cd /c/User/USERNAME/Desktop/github</code></pre>
<p>Under Mac OSX, you can change to a desktop folder by typing:</p>
<pre><code>cd /Users/USERNAME/Desktop/github</code></pre>
<p>Under Linux:</p>
<pre><code>cd /home/USERNAME/Desktop/github</code></pre>
</section>
<section id="make-a-repo-on-github" class="level2">
<h2 class="anchored" data-anchor-id="make-a-repo-on-github">Make a repo on GitHub</h2>
<p>Go to https://github.com and make sure you are logged in to your account. Click on [Repositories], then click the green [New] button.</p>
<p>This will open a form with several options. Enter the following:</p>
<ul>
<li>Repository name: <code>myrepo</code> (or whatever name you will easily remember).</li>
<li>Description: “<code>setup test</code>” (or something else, but it is good to get into practice of writing something descriptive in the README).</li>
<li>Public. <code>YES</code></li>
<li>Initialize this repository with a README.</li>
<li>For everything else, just accept the default.</li>
</ul>
<p>Click button [Create repository.]</p>
<p>This has created the remote copy of your repository. We now need to link this to a local copy on your computer. Click the green button [Code], and copy the HTTPS URL (if you click on the little clipboard icon this will get copied to your clipboard).</p>
<p>Once you have changed directory to where you want the local files saved, make a clone of your repository by typing the following into the terminal:</p>
<pre><code>git clone https://github.com/USERNAME/REPOSITORY.git</code></pre>
<p>Replace the <code>https://</code> address with the URL copied from GitHub. git will now make a new directory with the name of your repository and copy all files from GitHub to this directory. You should see something similar to the following output if this has been successful:</p>
<pre><code>Cloning into 'myrepo'...
remote: Enumerating objects: 3, done.
remote: Counting objects: 100% (3/3), done.
remote: Total 3 (delta 0), reused 0 (delta 0), pack-reused 0
Receiving objects: 100% (3/3), done.</code></pre>
<p>This will create a new folder with the name of the repository (<code>myrepo</code>). Change directory now and take a look at its contents.</p>
<pre><code>cd myrepo
ls
head README.md</code></pre>
<p>The <code>head</code> command will show you the first few lines of the README file. This is a markdown file and is used as the default landing page for your repository. Although we’ve just downloaded this, so know where it is linked to, we can check the address of the remote repository as follows:</p>
<pre><code>git remote show origin</code></pre>
<p>Another very useful command is <code>git status</code>, which provides a summary of the current repository, including</p>
<ul>
<li>Which branch you are working on (more on this later)</li>
<li>Whether or not files are being tracked (i.e.&nbsp;monitored for changes by git)</li>
<li>Whether files are in sync with the remote repository</li>
</ul>
</section>
</section>
<section id="working-with-branches-in-git" class="level1">
<h1>Working with branches in git</h1>
<p>Branches allow you to make parallel copies of your code for development. This is particularly useful as your code starts to become more mature or if you are collaborating on a project. For example, you can have one branch that contains the current stable, working version, and a second for development. As any changes to the development branch do not affect the working version, then you can safely experiment with your code. If these changes improve the stable version, you can then merge them back to that original branch. If they do not, then you can simply delete the new, development branch. Many larger projects use at least three branches: a main, stable version, a version for active development and a third for trying out experimental features.</p>
<p>These are equally useful for collaborative projects (we’ll look at these more in the next session). In a collaborative project, one person might be trying to add feature A, and someone else feature B. By organizing the code into branches, you can have the stable branch that no-one changes, and two additional branches for feature A and B respectively.</p>
<p>When you initialize a git repository, this is created with a single default branch, called <code>main</code> (previously this was called <code>master</code>). This branch is the one that is shown whenever anyone visits your repository, and is the initial branch that you get when you clone a repository. In general, you should consider this as the official, stable version of your project, and this should not be used for active development.</p>
<blockquote class="blockquote">
<p>Do not mess with the main. If you make changes to the main branch of a group project while other people are also working on it, your on-the-fly changes will ripple out to affect everyone else and very quickly there will be merge conflicts, weeping, rending of garments, and plagues of locusts. It’s that serious. Unless you specify a different branch, the main branch in a repository is the base branch for new pull requests and code commits.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
</blockquote>
<p>git manages branches through a system of <em>checkouts</em> that create new branches and switches between them, and <em>pull requests</em> that propose a set of changes from a child branch to a parent branch. Once the pull request has been accepted and the merge has taken place, then the child branch is usually deleted.</p>
<p>In this example, a default repository (<code>master</code>) has been established (green line). Two branches are then checked out, each set up to work on a single new feature (<code>feature1</code>, <code>feature2</code>). When feature 1 is complete, this is merged back to the <code>master</code> branch, through a pull request, followed by a second merge for feature 2.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="intro_to_git_2_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Example of git repository with two branches (https://digitalvarys.com/git-branch-and-its-operations/)</figcaption>
</figure>
</div>
</div>
</div>
<p>Note that it is also possible to checkout from a child branch. For example, you may have a child branch that contains working version of a new feature but you want to test a more different setup or more efficient version of this. You can then checkout a child of the existing child branch (a grandchild?). You can now test if it is worth this in your new working branch <em>before</em> merging this back to the production (<code>main</code>) branch. This does not affect the working version, <em>and</em> doesn’t mess with the main branch.</p>
<p>In this example, a second branch is checked out from <code>feature1</code>, then merged back prior to the intermediate branch. The subsequent merge of this with the main branch will include all changes.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="intro_to_git_2_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Example with sub-branches (https://docs.github.com)</figcaption>
</figure>
</div>
</div>
</div>
<p>If the intermediate branch is merged back and deleted, the lower level branch will be automatically re-assigned to the next higher level branch</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="intro_to_git_2_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Example with loss of higher level branch (https://docs.github.com)</figcaption>
</figure>
</div>
</div>
</div>
<section id="working-with-branches-from-the-terminal" class="level2">
<h2 class="anchored" data-anchor-id="working-with-branches-from-the-terminal">Working with branches from the terminal</h2>
<p>In this section, we’re going to look briefly at how to work with branches through the terminal (in case you want to work with non-R files). If your terminal is not already open, open it now and change to your <code>myrepo</code> repository. For example:</p>
<pre><code>cd /Users/username/Desktop/github/myrepo</code></pre>
<p>You can get a list of current branches through the terminal by typing <code>git branch -a</code>. If you try this for your existing repository, you should see something like the following, indicating that only the main branch exists.</p>
<pre><code>* main
  remotes/origin/HEAD -&gt; origin/main
  remotes/origin/main</code></pre>
<p>We are now going to make a new branch of this repository. I’m going to call it <code>devel</code> to represent a development branch, but feel free to use a different/more amusing name. To create this, simply type:</p>
<pre><code>git checkout -b devel</code></pre>
<p>As long as there is no existing branch with this name, you should see the following message:</p>
<pre><code>    Switched to a new branch 'devel'</code></pre>
<p>You can also use <code>git checkout</code> to switch between branches. To go back to the main branch:</p>
<pre><code>git checkout main</code></pre>
<p>And to switch back to the new branch:</p>
<pre><code>git checkout devel</code></pre>
<p>If you now run <code>git branch -a</code>, you should see the following output (or close to it):</p>
<pre><code>* devel
  main
  remotes/origin/HEAD -&gt; origin/main
  remotes/origin/main</code></pre>
<p>The <code>*</code> represent a pointer and indicates the current working repository. Make sure that this is pointing to your new branch, and then let’s add a file</p>
<pre><code>touch myLittlePonyScript.txt</code></pre>
<p>This will just create a blank text file in your repository (sorry - the real script is a secret). If you run <code>git status</code>, it should list this file as an untracked change. Let’s now add it to the branch and commit:</p>
<pre><code>git add myLittlePonyScript.txt
git commit -m "Added example text file"</code></pre>
<p>To demonstrate that this has not affected your <code>main</code> branch, first get the list of files from the new branch</p>
<pre><code>git ls-files</code></pre>
<p>Now change to the main branch, and list the associated files</p>
<pre><code>git checkout main
git ls-files</code></pre>
<p>And you should <strong>not</strong> see the new file listed. You can also at this point add some text to the new file. Note that you need to change back to the new branch to do this:</p>
<pre><code>git checkout devel
echo "Once upon a time in the land of Equestria..." &gt;&gt; myLittlePonyScript.txt</code></pre>
<p>Then stage and commit this change:</p>
<pre><code>git add myLittlePonyScript.txt
git commit -m "Added introduction..."</code></pre>
<p>Once you have finished making all the changes, we can merge this back to the <code>main</code> branch. Remember that this would usually be done when you have checked and tested any changes you’ve made, and your code is production ready. If it is not, it is better to keep it on the working or development branch.</p>
<p>In order to merge, <em>you need to be on the branch you want to merge to.</em> In this example, that means moving back to the <code>main</code> branch (run the <code>git branch</code> command just to check you are in the right place:</p>
<pre><code>git checkout main
git branch</code></pre>
<p>If you are sure you are in the right place, we can now merge the <code>devel</code> branch using <code>git merge</code>. For this we need to specify the branch we want to use. We also include the <code>--no-ff</code> argument to copy over all the previous commits from this branch. Run the following command in the terminal</p>
<pre><code>git merge devel --no-ff</code></pre>
<p>You will be asked to add a commit message to describe the merged changes, so do this. When you quit the text editor, you should see something similar to the following output if successful:</p>
<pre><code>Merge made by the 'recursive strategy'.
 myLittlePonyScript.txt | 1 +
 1 file changed, 1 insertion(+)
 create model 100644 myLittlePonyScript.txt</code></pre>
<p>Finally, we need to push the changes to GitHub:</p>
<pre><code>git push</code></pre>
<p>Once you see the confirmation notice, go to your GitHub page and check that the changes are visible there. If everything has worked, you can now delete your <code>devel</code> branch:</p>
<pre><code>git branch -d devel</code></pre>
</section>
<section id="using-branches-with-github" class="level2">
<h2 class="anchored" data-anchor-id="using-branches-with-github">Using branches with GitHub</h2>
<p>In the previous example, the <code>devel</code> branch that we created was entirely held locally (we only pushed the final changes to GitHub). If you want to create a remote copy of your new branch, then you need to run <code>git push -u origin NEWBRANCH</code> after it has been made. For example:</p>
<pre><code>git branch -b devel
git push -u origin devel</code></pre>
<p>You can now store your local commits to the <code>devel</code> branch by pushing these to GitHub. You can also control the merge through a pull request on GitHub (we’ll look at how to do this in the next session). Note that if you do this, you will need to delete both the remote and local copy of the branch when you are finished. The remote one can be deleted by going to your GitHub repository, clicking on the branches link:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="intro_to_git_2_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Then clicking on the little red trash can icon next to the branch name. You can now delete the local copy through the command line (the second line here just cleans up the links between your local and remote copy)</p>
<pre><code>git branch -d devel
git fetch --prune</code></pre>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://thenewstack.io/dont-mess-with-the-master-working-with-branches-in-git-and-github/<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>